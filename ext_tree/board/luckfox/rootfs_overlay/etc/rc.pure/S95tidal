#!/bin/sh

MIXER=`sed 's/,.*//' /tmp/mixer_control_cache`

start() {
    printf "Starting Tidalconnect: "
    
    # Mount SquashFS if exists (MAX firmware only)
    if [ -f /usr/lib/tidal.sqfs ] && [ ! -f /tmp/tidal_mounted ]; then
        mount -t squashfs -o loop,ro /usr/lib/tidal.sqfs /usr/lib/tidal 2>/dev/null && \
        touch /tmp/tidal_mounted
    fi
    
    export LD_LIBRARY_PATH=/usr/lib/tidal
    (
    tidalconnect \
    -f PureFox \
    --log-level 3 \
    --tc-certificate-path "/etc/ssl/private/tcon.crt" \
    --clientid "VCjoaRrbaMU005Tk" \
    > /dev/null 2>&1 < /dev/null &
    ) &
    sleep 1
    [ -n "$MIXER" ] && /usr/bin/amixer set "$MIXER" unmute 2>/dev/null
    pid=$(pidof tidalconnect)
    if [ -n "$pid" ]; then
    renice -15 $pid
    for tid in $(ls /proc/$pid/task/); do
        renice -15 $tid
    done
    fi

    # Refresh avahi to announce tidal service
    /etc/init.d/S50avahi-daemon restart > /dev/null 2>&1

    exit
}

stop() {
    [ -n "$MIXER" ] && /usr/bin/amixer set "$MIXER" mute 2>/dev/null
    killall -9 tidalconnect
    export LD_LIBRARY_PATH=""
    
    # Unmount SquashFS if mounted
    if [ -f /tmp/tidal_mounted ]; then
        umount /usr/lib/tidal 2>/dev/null || true
        rm -f /tmp/tidal_mounted
    fi
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
  start|stop|restart)
    "$1"
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit $?
