#!/bin/sh

MIXER=`sed 's/,.*//' /tmp/mixer_control_cache`

NAME=`hostname`_`ifconfig eth0 | awk '/inet addr/{print substr($2,6)}'`

# Auto-detect DSD format support by testing with aplay
DSD_FORMAT="u32le"  # Default for most DACs

# Detect audio device from asound.conf
AUDIO_DEV="default"
if [ -f /etc/asound.conf ]; then
    CARD_NUM=$(grep "^card" /etc/asound.conf | head -1 | awk '{print $2}')
    if [ -n "$CARD_NUM" ] && [ -d "/proc/asound/card$CARD_NUM" ]; then
        AUDIO_DEV="hw:$CARD_NUM,0"
    fi
fi

# Get supported formats from device
HW_PARAMS=$(aplay -v -D "$AUDIO_DEV" --dump-hw-params /dev/zero 2>&1)

# Check for DSD formats in order of preference (BE first for native DSD DACs)
if echo "$HW_PARAMS" | grep -q "DSD_U32_BE"; then
    DSD_FORMAT="u32be"
elif echo "$HW_PARAMS" | grep -q "DSD_U32_LE"; then
    DSD_FORMAT="u32le"
elif echo "$HW_PARAMS" | grep -q "DSD_U16_BE"; then
    DSD_FORMAT="u16be"
elif echo "$HW_PARAMS" | grep -q "DSD_U16_LE"; then
    DSD_FORMAT="u16le"
fi

OPTIONS="-z -D 1000:$DSD_FORMAT -r 44100-22579200:1000 -a 400:3::0 -M $NAME"

start() {
        printf "Starting Squeezelite: "
	/usr/bin/squeezelite $OPTIONS
        pid=$(pidof squeezelite)
        if [ -n "$pid" ]; then
        renice -15 $pid
        for tid in $(ls /proc/$pid/task/); do
            sleep 0.1
            renice -15 $tid
        done
        fi
        [ -n "$MIXER" ] && /usr/bin/amixer set "$MIXER" unmute 2>/dev/null
    }
stop() {
    [ -n "$MIXER" ] && /usr/bin/amixer set "$MIXER" mute 2>/dev/null
    killall -9 squeezelite
}
restart() {
	stop
	start
}
case "$1" in
  start|stop|restart)
	"$1"
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?
