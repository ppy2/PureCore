#!/bin/sh


start() {
    date |grep 1970 && /etc/init.d/S48sntp start
    printf "Starting Spotify: "
    
    # Determine active ALSA card number from asound.conf
    CARD_NUM=$(grep -E "card [0-9]" /etc/asound.conf 2>/dev/null | head -1 | awk '{print $2}')
    if [ -z "$CARD_NUM" ]; then
        # Fallback: try hw:X,X pattern
        CARD_NUM=$(grep -E "hw:[0-9]" /etc/asound.conf 2>/dev/null | head -1 | sed 's/.*hw:\([0-9]\).*/\1/')
    fi
    [ -z "$CARD_NUM" ] && CARD_NUM=0
    
    # Check if sound card exists before starting librespot
    if [ ! -d "/proc/asound/card$CARD_NUM" ]; then
        echo "ERROR: Sound card $CARD_NUM not found (configured in /etc/asound.conf but device missing)"
        echo "Available cards:"
        ls -d /proc/asound/card* 2>/dev/null || echo "  No sound cards detected"
        echo "Librespot will panic with 100% CPU if started without audio device. Aborting."
        exit 1
    fi
    
    # Wait for sound device to be free (up to 10 seconds)
    RETRY=0
    while [ $RETRY -lt 10 ]; do
        if ! fuser /dev/snd/pcmC${CARD_NUM}* >/dev/null 2>&1; then
            break
        fi
        logger -t spotify "Sound card $CARD_NUM busy, waiting... ($RETRY/10)" 2>/dev/null || true
        sleep 1
        RETRY=$((RETRY + 1))
    done
    
    if [ $RETRY -eq 10 ]; then
        logger -t spotify "ERROR: Sound card still busy after 10s, cannot start librespot" 2>/dev/null || true
        exit 1
    fi
    
    NAME=`hostname`_`ifconfig eth0 | awk '/inet addr/{print substr($2,6)}'`
    renice -15 $$ 
    /usr/bin/librespot --cache /tmp --cache-size-limit 64M --bitrate 320 -R 100 --name $NAME > /dev/null 2>&1 &
    sleep 0.5
    if [ -f /tmp/mixer_control_cache ]; then
        MIXER=$(cat /tmp/mixer_control_cache | cut -d, -f1 | tr -d "'")
        [ -n "$MIXER" ] && amixer set "$MIXER" unmute 2>/dev/null
    fi
}

stop() {
    killall -9 librespot 2>/dev/null
}
restart() {
	stop
	start
}
case "$1" in
  start|stop|restart)
	"$1"
	;;
  *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac

exit $?


