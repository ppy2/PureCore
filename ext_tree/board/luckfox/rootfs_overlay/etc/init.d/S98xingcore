#!/bin/sh

# XingCore UAC2 Gadget Auto-start Script - ПОЛНАЯ ЭМУЛЯЦИЯ
# Запускается последним в автозагрузке
#
# ЭМУЛИРОВАНО через configfs:
# ✓ Device Qualifier: 0x00/0x00/0x00
# ✓ Self-powered, 100mA
# ✓ Минимальные string descriptors
# ✓ iConfiguration = 0x00, iFunction = 0x00
#
# ТРЕБУЮТ ПАТЧЕЙ ЯДРА (f_uac2.c):
# ✗ HIGH BANDWIDTH mode (2x800 vs 1x808) - line 786-827
# ✗ Lock Delay (0x02, 0x0800) - нужны configfs атрибуты
# ✗ Вторая vendor-specific конфигурация

start() {
    echo "Starting XingCore UAC2 gadget..."
    sleep 2  # Даем время на инициализацию USB

    # Проверяем доступен ли UDC
    if [ ! -d /sys/class/udc ]; then
        echo "UDC not available, skipping XingCore gadget"
        return 1
    fi

    # Создаем XingCore гаджет
    cd /sys/kernel/config/usb_gadget

    # Полностью удаляем старый gadget если существует
    if [ -d "xingcore" ]; then
        cd xingcore
        echo "" > UDC 2>/dev/null
        rm -f configs/c.1/uac2.0 2>/dev/null
        rmdir configs/c.1/strings/0x409 2>/dev/null
        rmdir configs/c.1 2>/dev/null
        rmdir functions/uac2.0 2>/dev/null
        rmdir strings/0x409 2>/dev/null
        cd ..
        rmdir xingcore 2>/dev/null
    fi

    mkdir -p xingcore
    cd xingcore

    # Device Descriptor (XingCore clone - полная эмуляция)
    echo 0x152a > idVendor
    echo 0x8852 > idProduct
    echo 0x0312 > bcdDevice
    echo 0x0200 > bcdUSB
    # Device Qualifier: 0x00/0x00/0x00 как в оригинале
    echo 0x00 > bDeviceClass
    echo 0x00 > bDeviceSubClass
    echo 0x00 > bDeviceProtocol
    echo 64 > bMaxPacketSize0

    # Device Strings - минимальные как в оригинале
    mkdir -p strings/0x409
    echo "XingCore" > strings/0x409/manufacturer
    echo "XingCore USB Hi-Resolution Audio" > strings/0x409/product
    # Serial number = 0x00 (пустой) как в оригинале
    echo "" > strings/0x409/serialnumber

    # UAC2 Function
    mkdir -p functions/uac2.0

    # WORKAROUND: Due to kernel driver confusion between EPIN/EPOUT paths
    # We use c_chmask for playback (creates EPOUT with correct Speaker terminal)
    # instead of p_chmask (creates EPIN with wrong Microphone terminal)
    
    # "Capture" settings (actually used for playback due to kernel bug)
    echo 3 > functions/uac2.0/c_chmask
    echo "44100,48000,88200,96000,176400,192000,352800,384000,705600,768000" > functions/uac2.0/c_srate
    echo 4 > functions/uac2.0/c_ssize
    echo 1 > functions/uac2.0/c_mute_present
    echo 1 > functions/uac2.0/c_volume_present
    echo 1 > functions/uac2.0/c_hs_bint  # bInterval=1 как в оригинальном XingCore

    # Оптимизированные буферы для Roon WASAPI совместимости
    echo 16 > functions/uac2.0/req_number   # Больше USB request буферов (critical for Roon!)
    # XingCore emulation: fb_max=1083 даёт ТОЧНО 2x800 HIGH BANDWIDTH = 0x0B20
    echo 1083 > functions/uac2.0/fb_max      # Async overhead для HIGH BANDWIDTH

    # No playback (we use capture path for playback)
    echo 0 > functions/uac2.0/p_chmask
    # Function name = пустая (0x00) как в оригинале

    # Configuration - Self-powered как в оригинале
    mkdir -p configs/c.1
    # Self-powered: bmAttributes = 0xC0 (bit 7=1, bit 6=1)
    echo 0xC0 > configs/c.1/bmAttributes
    # MaxPower = 100mA (0x32) как в оригинале
    echo 100 > configs/c.1/MaxPower
    # Убираем строки конфигурации (iConfiguration = 0x00)
    # mkdir -p configs/c.1/strings/0x409  # НЕ создаём!
    ln -s functions/uac2.0 configs/c.1/

    # Enable gadget
    ls /sys/class/udc > UDC

    echo "XingCore UAC2 gadget started automatically"
}

case "$1" in
  start)
    start
    ;;
  stop)
    echo "Stopping XingCore gadget..."
    cd /sys/kernel/config/usb_gadget/xingcore 2>/dev/null && echo "" > UDC 2>/dev/null
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac