#!/bin/sh

# PureCore UAC2 Gadget Auto-start Script - FULL EMULATION
# Runs last in the boot sequence
#
# EMULATED via configfs:
# ✓ Device Qualifier: 0x00/0x00/0x00
# ✓ Self-powered, 100mA
# ✓ Minimal string descriptors
# ✓ iConfiguration = 0x00, iFunction = 0x00
#
# REQUIRE KERNEL PATCHES (f_uac2.c):
# ✗ HIGH BANDWIDTH mode (2x800 vs 1x808) - line 786-827
# ✗ Lock Delay (0x02, 0x0800) - need configfs attributes
# ✗ Second vendor-specific configuration

start() {
    echo "Starting PureCore UAC2 gadget..."
    sleep 2  # Give time for USB initialization

    # Check if UDC is available
    if [ ! -d /sys/class/udc ]; then
        echo "UDC not available, skipping PureCore gadget"
        return 1
    fi

    # Create PureCore gadget
    cd /sys/kernel/config/usb_gadget

    # Completely remove old gadget if it exists
    if [ -d "purecore" ]; then
        cd purecore
        echo "" > UDC 2>/dev/null
        rm -f configs/c.1/uac2.usb0 2>/dev/null
        rm -f configs/c.2/vendor.0 2>/dev/null
        rmdir configs/c.1 2>/dev/null
        rmdir configs/c.2 2>/dev/null
        rmdir functions/uac2.usb0 2>/dev/null
        rmdir functions/vendor.0 2>/dev/null
        rmdir strings/0x409 2>/dev/null
        cd ..
        rmdir purecore 2>/dev/null
    fi

    mkdir -p purecore
    cd purecore

    # Device Descriptor (original PureCore ID)
#    echo 0x1209 > idVendor
#    echo 0x2468 > idProduct
    echo 0x152A > idVendor
    echo 0x8852 > idProduct
    echo 0x0312 > bcdDevice
    echo 0x0200 > bcdUSB
    # Standard UAC2: Device Class 0x00 (defined by interfaces)
    echo 0x00 > bDeviceClass      # Defined by interfaces
    echo 0x00 > bDeviceSubClass   # Defined by interfaces
    echo 0x00 > bDeviceProtocol   # Defined by interfaces
    echo 64 > bMaxPacketSize0

    # Device Strings - minimal as in the original
    mkdir -p strings/0x409
    echo "PureCore" > strings/0x409/manufacturer
    echo "PureCore USB Hi-Resolution Audio" > strings/0x409/product
    # Serial number = 0x00 (empty) as in the original
    echo "" > strings/0x409/serialnumber

    # UAC2 Function
    mkdir -p functions/uac2.usb0

    # CRITICAL FIX: Stock f_uac2.c has REVERSED naming!
    # p_chmask controls EPIN (capture/mic), c_chmask controls EPOUT (playback/speaker)
    echo 0 > functions/uac2.usb0/p_chmask  # Disable p (actually capture/mic)
    echo 3 > functions/uac2.usb0/c_chmask  # Enable c (actually playback/speaker)
    # PCM rates up to 768kHz + native DSD64-512 (for Linux Alt Setting 2)
    echo "44100,48000,88200,96000,176400,192000,352800,384000,705600,768000,2822400,5644800,11289600,22579200" > functions/uac2.usb0/c_srate
    echo 4 > functions/uac2.usb0/c_ssize
    echo 1 > functions/uac2.usb0/c_mute_present
    echo 1 > functions/uac2.usb0/c_volume_present
    # c_hs_bint=0 allows kernel to auto-select optimal bInterval for DSD512
    # Kernel will choose bInterval=8 for DSD512 to fit in USB 2.0 bandwidth

    # Fix p_volume parameters even though p_chmask=0 (kernel validates all params regardless)
    echo 0 > functions/uac2.usb0/p_volume_min
    echo 256 > functions/uac2.usb0/p_volume_max
    echo 256 > functions/uac2.usb0/p_volume_res

    # IMPORTANT: Set p_srate and p_ssize for capture (UAC2 input from host)
    # Even though p_chmask=0, these are required for proper UAC2 function
    echo "44100,48000,88200,96000,176400,192000,352800,384000,705600,768000,2822400,5644800,11289600,22579200" > functions/uac2.usb0/p_srate
    echo 4 > functions/uac2.usb0/p_ssize

    # CRITICALLY IMPORTANT: Parameters for supporting up to DSD512
    echo 8 > functions/uac2.usb0/req_number    # USB request buffers (increased for DSD512)
    # fb_max=24 (2.4% overhead) allows DSD512 to fit in USB 2.0 HS bandwidth
    # 22579200Hz * 1.024 / 8000 * 2ch * 4bytes = 23138 bytes → needs bInterval=8
    echo 24 > functions/uac2.usb0/fb_max       # Async overhead optimized for DSD512

    # Function name - shown in Windows as device name
    echo "PureCore" > functions/uac2.usb0/function_name

    # Configuration 1 - UAC2 Audio (Self-powered)
    mkdir -p configs/c.1
    echo 0xC0 > configs/c.1/bmAttributes  # Self-powered
    echo 100 > configs/c.1/MaxPower       # 100mA
    # iConfiguration = 0x00 (don't create strings!)
    ln -s functions/uac2.usb0 configs/c.1/

    # Configuration 2 - DISABLED for standard UAC2 (no PureCore driver needed)
    # mkdir -p functions/vendor.0
    # mkdir -p configs/c.2
    # echo 0xC0 > configs/c.2/bmAttributes  # Self-powered
    # echo 100 > configs/c.2/MaxPower       # 100mA
    # iConfiguration = 0x00 (don't create strings!)
    # ln -s functions/vendor.0 configs/c.2/

    # Enable gadget
    ls /sys/class/udc > UDC

    echo "PureCore UAC2 gadget with 2 configurations started"
}

case "$1" in
  start)
    start
    ;;
  stop)
    echo "Stopping PureCore gadget..."
    cd /sys/kernel/config/usb_gadget/purecore 2>/dev/null && echo "" > UDC 2>/dev/null
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac